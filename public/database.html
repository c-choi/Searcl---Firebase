<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="">
        <meta name="author" content="">
        <title>Searcl</title>
        <!-- Bootstrap core CSS -->
        <link href="bootstrap/css/theme.css" rel="stylesheet">
        <!-- Custom styles for this template -->
        <link href="style.css" rel="stylesheet">
        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
        <link href='https://fonts.googleapis.com/css?family=Roboto+Slab:400,300,700,100' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Raleway:300,700,900,500' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/typicons/2.0.7/typicons.min.css">
        <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
        <link rel="stylesheet" href="assets/css/pushy.css">
        <link rel="stylesheet" href="assets/css/masonry.css">
        <link rel="stylesheet" href="assets/css/animate.css">
        <link rel="stylesheet" href="assets/css/magnific-popup.css">
        <link rel="stylesheet" href="assets/css/odometer-theme-default.css">
        
        <script>
          window.fbAsyncInit = function() {
            FB.init({
              appId      : '1855355218063481',
              cookie     : true,
              xfbml      : true,
              version    : 'v2.8'
            });
            FB.AppEvents.logPageView();   
          };

          (function(d, s, id){
             var js, fjs = d.getElementsByTagName(s)[0];
             if (d.getElementById(id)) {return;}
             js = d.createElement(s); js.id = id;
             js.src = "//connect.facebook.net/en_US/sdk.js";
             fjs.parentNode.insertBefore(js, fjs);
           }(document, 'script', 'facebook-jssdk'));
        </script>
    </head>

<body class="">

  <!-- Pushy Menu -->
      <nav class="pushy pushy-left">
        <ul class="list-unstyled">
            <li><a href="#home">Searcl</a></li>
            <li><a href="#about">About</a></li>
            <li><a href="#news">소식</a></li>
            <li><a href="#info">정보</a></li>
            <li><a href="#review">리뷰</a></li>
<!--             <li><a href="#photos">이미지</a></li> -->
            <li><a href="#contact">연락하기</a></li>
            <li><a href="#">
            <p id="AUTH_STATE" class="blue-text">로그인</p>
                <!-- 로그인 상태 -->
                        

                        <!-- user info -->
                        <span id="USER_INFO" style="text-align: left;">
                        <span id="USER_NAME" class="blue-text"></span>
                        <span id="USER_MAIL" class="blue-text"></span>
                        <img id="USER_PHOTO" style="width:50px; text-align: center">
                        <!-- <span id="USER_UID" class="blue-text"></span> -->
                        </span>

                        <div>
                        <!-- Login button -->
                        <p><button type="button" id="BTN_GOOGLE_LOGIN" type="button" class="btn btn-primary">구글 인증</button></p>
                        <p><button type="button" id="BTN_FACEBOOK_LOGIN" type="button" class="btn btn-primary">페이스북 인증</button></p>
                        <!-- Logout button -->
                        <p><button type="button" id="BTN_LOGOUT" type="button" class="btn btn-primary" style="display:none;">로그아웃</button></p>
                        </div>
                        </a>
            </li>
        </ul>
      </nav>

      <!-- Site Overlay -->
      <div class="site-overlay"></div>

      <div class="title-container">
                    <div class="row ">
                        <div class="col-lg-offset-1 col-lg-2 col-md-offset-1 col-md-3 col-xs-offset-1 col-xs-4">
                            <a href="#" class="thumbnail logo">
                               <!--  <img src="images/logo.png" alt="" class="img-responsive"> -->
                            </a>
                        </div>
                        <div class="col-md-1 col-md-offset-7 col-xs-offset-5 col-xs-2 text-center">
                          <div class="menu-btn"><span class="hamburger-black">&#9776;</span>
                          </div>
                        </div>
                    </div>

  <!-- 내용 부분 -->
  <div class="container container-fluid" id="CONTENTS">

    <div class="row">
      <div class="col-lg-12 col-mg-12 col-sm-12">

        <p>
          데이터베이스 메세지 :
          <!-- TODO 4. 상태 보기용 span 확인-->
           <span id="DB_MESSAGE" class="blue-text">(Loading..)</span>
         </p>
      </div>
    </div>

    <!-- TODO 5. 메세지 수정 폼 확인하기 -->
    <div class="row">
      <div class="col-lg-9 col-md-9 col-sm-12 input-field">
       <input id="INPUT_MESSAGE" type="text" class="validate">
       <label for="INPUT_MESSAGE">변경할 메세지</label>
      </div>
      <div class="col-lg-3 col-md-3 col-sm-12 input-field">
          <button id="BTN_UPDATE" type="button" class="btn btn-primary">변경하기</button>
      </div>
    </div>



  </div>

  <!-- 바닥글 영역 -->
  <footer>
            <div class="container">
                <div class="row">
                    <div class="col-md-8 lefty">
                        <h3>Searcl</h3>
                        <p>© 2017 Searcl. Designed and Developed by <a target="_blank" href="http://www.themeinthebox.com">ThemeintheBox.com</a></p>

                        </div>
                        <!--
                        -->
                    </div>
                    <div class="col-md-4">
                        <p class="text-right social"><i class="typcn typcn-social-facebook-circular"></i><i class="typcn typcn-social-twitter-circular"></i><i class="typcn typcn-social-tumbler-circular"></i><i class="typcn typcn-social-github-circular"></i><i class="typcn typcn-social-dribbble-circular"></i></p>
                    </div>
                </div>
            </div>
        </footer>

        <!-- Bootstrap core JavaScript
    ================================================== -->
        <!-- Placed at the end of the document so the pages load faster -->

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <script src="assets/js/jquery.min.js"></script>
        <script src="bootstrap/js/bootstrap.min.js"></script>
        <script src="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.0.4/js/bootstrap-scrollspy.js"></script>
        <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
        <script src="assets/js/ie10-viewport-bug-workaround.js"></script>
        <script src="assets/js/masonry.js"></script>
        <script src="assets/js/pushy.min.js"></script>
        <script src="assets/js/jquery.magnific-popup.min.js"></script>
        <script src="assets/js/wow.min.js"></script>
        <script src="assets/js/scripts.js"></script>
        <script src="assets/js/odometer.js"></script>
        <script src="parallax.js-1.3.1/parallax.js"></script>

  <!-- 1. firebase SDK 링크 -->
  <link type="text/css" rel="stylesheet" href="assets/css/firebaseui.css" />
        <script src="https://www.gstatic.com/firebasejs/4.1.3/firebase.js"></script>
        <script src="https://www.gstatic.com/firebasejs/4.1.3/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/4.1.3/firebase-auth.js"></script>
        <script src="https://www.gstatic.com/firebasejs/4.1.3/firebase-database.js"></script>
        <script src="https://www.gstatic.com/firebasejs/4.1.3/firebase-messaging.js"></script>
        <script src="assets/js/firebaseui.js"></script>
        <script src="/fireinit.js"></script>
        <script src="/firelogin.js"></script>
  <script type="text/javascript">
    /* 1. 버튼을 눌렀을 경우 구글 인증 동작하게 */
    $('#BTN_GOOGLE_LOGIN').click(function(){
      var provider = new firebase.auth.GoogleAuthProvider();
      firebase.auth().signInWithPopup(provider).then(function(result) {
      }).catch(function(error) {
        alert(error.message)
      });
    });
    /* 1. 인증 해제 */
    $('#BTN_LOGOUT').click(function(){
      // 4. DB의 변화를 더이상 감지 하지 않음
      firebase.database().ref('/onUsers/').off();
      // 3. 접속상태값을 변경
      firebase.database().ref("/onUsers/"+_uid+"/siteOn").set(0);
      $("#SITE_ON_USERS").html(''); // 5. 접속 유저 목록 초기화
      // 인증 해제
      firebase.auth().signOut().then(function() {
        alert("인증이 해제되었습니다.");
      }, function(error) {
        alert(error.message);
      });
    });
    /* 2. 접속한 경우 Database의 상태 변경 */
    var _uid = null; // 유저의 uid를 저장해둘 전역 변수
    firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        _uid = user.uid;
        $("#LOG_MESSAGE").text(user.displayName+"님 접속하셨습니다");
        // 3. 디비에 접속 하면 상태 변경 (등록이 안된 상태면 새로 쓰기)
        firebase.database().ref('/onUsers/' + _uid).set({"username": user.displayName, "siteOn": 1});
        // 4. 상태가 바뀔 때를 감지할 리스너(JS옵저버) 장착
        firebase.database().ref('/onUsers/').on('value', function(snapshot_users) {
          $("#SITE_ON_USERS").html(''); // 5. 접속 유저 목록 초기화
          // 5. 유저를 하나씩 읽어오기
          firebase.database().ref('/onUsers/').on("child_added", function(snapshot) {
            if (snapshot.val().siteOn == 1) {
              var li_tag = '<li>'+ snapshot.val().username +'</li>';
              $("#SITE_ON_USERS").append(li_tag);
            }
          });
        });
        // 7. 디비에 접속 끊길때 이벤트 감지하하면 특정값 변경 (siteOn 상태를 0으로 변경)
        firebase.database().ref("/onUsers/"+ _uid+"/siteOn").onDisconnect().set(0);
      } else { // 2. 인증이 해제 되거나 인증되지 않은 경우
        $("#LOG_MESSAGE").text("(인증하셔야 볼 수 있습니다)");
        _uid = null;
      }
    });
    // 6. 페이지 떠나게 되면
   $(window).on("beforeunload", function(){
     if(_uid != null){
       firebase.database().ref("/onUsers/"+_uid+"/siteOn").set(0); // 상태 변경
     }
   });

    /* TODO 3. 데이터 베이스 '/메세지' 쓰기 */
    // 녕
    /* TODO 4. DB에서 '/메세지'값 읽어오기 */
    firebase.database().ref("/onUsers/"+ _uid + '/message').on('value', function(snapshot) {
      var message = snapshot.val();
      $("#DB_MESSAGE").text(message);
    });
    /* TODO 5. DB 메세지 값 변경 */
    $("#BTN_UPDATE").click(function(){
      var new_message = $("#INPUT_MESSAGE").val();
      var messageTime = timeStamp.val();
        firebase.database().ref("/onUsers/" + _uid + '/message/').set(messageTime);
        firebase.database().ref("/onUsers/" + _uid + '/message/' + messageTime).set(new_message);
     
    });

  </script>
  <script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-59106832-5', 'auto');
ga('send', 'pageview');
</script> 
</body>
</html>